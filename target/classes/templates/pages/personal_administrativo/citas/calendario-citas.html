<!-- Fragmento para Calendario de Citas -->
<div th:fragment="calendario-citas">
    <style>
        .calendar-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
        }
        
        .filters-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .appointment-card {
            border-left: 4px solid #007bff;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .appointment-card.urgent {
            border-left-color: #dc3545;
        }
        
        .appointment-card.completed {
            border-left-color: #28a745;
            opacity: 0.7;
        }
        
        .appointment-card.cancelled {
            border-left-color: #6c757d;
            opacity: 0.5;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
        }
        
        .calendar-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-calendar-nav {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .btn-calendar-nav:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .view-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-view {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .btn-view.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .btn-view:hover {
            background: #e9ecef;
        }
        
        .btn-view.active:hover {
            background: #0056b3;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.85rem;
        }
        
        .fc-event.urgent {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .fc-event.normal {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .fc-event.completed {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .fc-event.cancelled {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        
        .quick-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        
        .btn-quick-action {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #007bff;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-quick-action:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,123,255,0.4);
        }
        
        .btn-quick-action.secondary {
            background: #28a745;
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        
        .btn-quick-action.secondary:hover {
            box-shadow: 0 6px 16px rgba(40,167,69,0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">
                        <i class="bi bi-calendar-week text-primary"></i>
                        Calendario de Citas
                    </h2>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number text-primary">24</div>
                <div class="stat-label">Citas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number text-success">18</div>
                <div class="stat-label">Completadas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number text-warning">4</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number text-danger">2</div>
                <div class="stat-label">Urgentes</div>
            </div>
        </div>

        <!-- Panel de Filtros -->
        <div class="filters-panel">
            <div class="row">
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="filterDoctor">Médico</label>
                        <select class="form-select" id="filterDoctor">
                            <option value="">Todos los médicos</option>
                            <option value="1">Dr. Carlos Mendoza</option>
                            <option value="2">Dra. Ana Silva</option>
                            <option value="3">Dr. Roberto Torres</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="filterSpecialty">Especialidad</label>
                        <select class="form-select" id="filterSpecialty">
                            <option value="">Todas las especialidades</option>
                            <option value="1">Medicina General</option>
                            <option value="2">Cardiología</option>
                            <option value="3">Dermatología</option>
                            <option value="4">Ginecología</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="filterStatus">Estado</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">Todos los estados</option>
                            <option value="pending">Pendiente</option>
                            <option value="completed">Completada</option>
                            <option value="cancelled">Cancelada</option>
                            <option value="urgent">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="filterDate">Rango de Fechas</label>
                        <input type="text" class="form-control" id="filterDate" placeholder="Seleccionar rango">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <button class="btn btn-primary me-2">
                        <i class="bi bi-funnel"></i>
                        Aplicar Filtros
                    </button>
                    <button class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendario -->
        <div class="calendar-container">
            <div class="calendar-toolbar">
                <div class="calendar-nav">
                    <button class="btn-calendar-nav" id="prevBtn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <h4 id="currentDate">Enero 2024</h4>
                    <button class="btn-calendar-nav" id="nextBtn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn-calendar-nav" id="todayBtn">
                        Hoy
                    </button>
                </div>
                
                <div class="view-buttons">
                    <button class="btn-view active" data-view="dayGridMonth">Mes</button>
                    <button class="btn-view" data-view="timeGridWeek">Semana</button>
                    <button class="btn-view" data-view="timeGridDay">Día</button>
                    <button class="btn-view" data-view="listWeek">Lista</button>
                </div>
            </div>
            
            <div id="calendar"></div>
        </div>

        <!-- Lista de Próximas Citas (Panel Lateral) -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="calendar-container">
                    <h5 class="mb-3">
                        <i class="bi bi-clock"></i>
                        Próximas Citas
                    </h5>
                    
                    <div class="appointment-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">Juan Pérez</h6>
                            <span class="status-badge badge bg-warning">Pendiente</span>
                        </div>
                        <p class="mb-1 text-muted">Dr. Carlos Mendoza - Medicina General</p>
                        <small class="text-muted">Hoy, 10:00 AM</small>
                    </div>
                    
                    <div class="appointment-card urgent">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">María García</h6>
                            <span class="status-badge badge bg-danger">Urgente</span>
                        </div>
                        <p class="mb-1 text-muted">Dra. Ana Silva - Cardiología</p>
                        <small class="text-muted">Hoy, 11:30 AM</small>
                    </div>
                    
                    <div class="appointment-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">Carlos López</h6>
                            <span class="status-badge badge bg-warning">Pendiente</span>
                        </div>
                        <p class="mb-1 text-muted">Dr. Roberto Torres - Dermatología</p>
                        <small class="text-muted">Hoy, 02:00 PM</small>
                    </div>
                    
                    <div class="appointment-card completed">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">Ana Martínez</h6>
                            <span class="status-badge badge bg-success">Completada</span>
                        </div>
                        <p class="mb-1 text-muted">Dr. Carlos Mendoza - Medicina General</p>
                        <small class="text-muted">Hoy, 09:00 AM</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="calendar-container">
                    <h5 class="mb-3">
                        <i class="bi bi-graph-up"></i>
                        Resumen del Día
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Distribución por Especialidad</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Medicina General</span>
                                    <span class="badge bg-primary">12</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Cardiología</span>
                                    <span class="badge bg-success">5</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Dermatología</span>
                                    <span class="badge bg-info">4</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Ginecología</span>
                                    <span class="badge bg-warning">3</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Distribución por Médico</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Dr. Carlos Mendoza</span>
                                    <span class="badge bg-primary">8</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Dra. Ana Silva</span>
                                    <span class="badge bg-success">7</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Dr. Roberto Torres</span>
                                    <span class="badge bg-info">6</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between">
                                    <span>Dra. Patricia Ruiz</span>
                                    <span class="badge bg-warning">3</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Acción Rápida -->
    <div class="quick-actions">
        <button class="btn-quick-action" title="Nueva Cita" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">
            <i class="bi bi-plus"></i>
        </button>
        <button class="btn-quick-action secondary" title="Exportar Calendario">
            <i class="bi bi-download"></i>
        </button>
    </div>

    <!-- Modal para Nueva Cita -->
    <div class="modal fade" id="newAppointmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus"></i>
                        Nueva Cita
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Paciente</label>
                                <select class="form-select">
                                    <option>Seleccionar paciente...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Médico</label>
                                <select class="form-select">
                                    <option>Seleccionar médico...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hora</label>
                                <input type="time" class="form-control">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary">Agendar Cita</button>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>

<script>
    // Inicializar calendario cuando se muestre el tab
    function initCalendarioCitasTab() {
        if (typeof FullCalendar !== 'undefined') {
            // Inicializar FullCalendar
            var calendarEl = document.getElementById('calendar');
            if (calendarEl && !calendarEl.hasAttribute('data-initialized')) {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    headerToolbar: false, // Usamos nuestro toolbar personalizado
                    height: 600,
                    events: [
                        {
                            title: 'Juan Pérez - Dr. Mendoza',
                            start: '2024-01-15T10:00:00',
                            end: '2024-01-15T11:00:00',
                            className: 'normal',
                            extendedProps: {
                                patient: 'Juan Pérez',
                                doctor: 'Dr. Carlos Mendoza',
                                specialty: 'Medicina General',
                                status: 'pending'
                            }
                        },
                        {
                            title: 'María García - Dra. Silva',
                            start: '2024-01-15T11:30:00',
                            end: '2024-01-15T12:30:00',
                            className: 'urgent',
                            extendedProps: {
                                patient: 'María García',
                                doctor: 'Dra. Ana Silva',
                                specialty: 'Cardiología',
                                status: 'urgent'
                            }
                        },
                        {
                            title: 'Carlos López - Dr. Torres',
                            start: '2024-01-15T14:00:00',
                            end: '2024-01-15T15:00:00',
                            className: 'normal',
                            extendedProps: {
                                patient: 'Carlos López',
                                doctor: 'Dr. Roberto Torres',
                                specialty: 'Dermatología',
                                status: 'pending'
                            }
                        },
                        {
                            title: 'Ana Martínez - Dr. Mendoza',
                            start: '2024-01-15T09:00:00',
                            end: '2024-01-15T10:00:00',
                            className: 'completed',
                            extendedProps: {
                                patient: 'Ana Martínez',
                                doctor: 'Dr. Carlos Mendoza',
                                specialty: 'Medicina General',
                                status: 'completed'
                            }
                        }
                    ],
                    eventClick: function(info) {
                        // Mostrar detalles de la cita
                        alert('Cita: ' + info.event.title + '\nEstado: ' + info.event.extendedProps.status);
                    }
                });
                calendar.render();
                calendarEl.setAttribute('data-initialized', 'true');

                // Navegación del calendario
                document.getElementById('prevBtn').addEventListener('click', function() {
                    calendar.prev();
                    updateCurrentDate();
                });

                document.getElementById('nextBtn').addEventListener('click', function() {
                    calendar.next();
                    updateCurrentDate();
                });

                document.getElementById('todayBtn').addEventListener('click', function() {
                    calendar.today();
                    updateCurrentDate();
                });

                // Cambio de vista
                document.querySelectorAll('.btn-view').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        calendar.changeView(this.dataset.view);
                    });
                });

                function updateCurrentDate() {
                    var currentDate = calendar.view.title;
                    document.getElementById('currentDate').textContent = currentDate;
                }
            }
        }

        // Inicializar Select2
        if (typeof $ !== 'undefined') {
            $('#filterDoctor, #filterSpecialty, #filterStatus').select2({
                placeholder: "Seleccionar...",
                allowClear: true
            });
        }

        // Filtros
        document.querySelectorAll('#filterDoctor, #filterSpecialty, #filterStatus').forEach(function(select) {
            select.addEventListener('change', function() {
                // Aquí iría la lógica para filtrar eventos
                console.log('Filtro aplicado:', this.value);
            });
        });
    }

    // Ejecutar cuando se muestre el tab
    $(document).ready(function() {
        $('#calendario-citas-tab').on('shown.bs.tab', function() {
            setTimeout(initCalendarioCitasTab, 100);
        });
    });
</script>
